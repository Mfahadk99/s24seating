<!DOCTYPE html>
<html class="loading" lang="en" data-textdirection="ltr">
<!-- BEGIN: Head-->

<head>
  <!-- head partial -->
  <%- include('../partials/head.ejs') %>

    <!-- styles partial -->
    <%- include('../partials/styles.ejs') %>

      <style>
        .clickable:hover {
          border-right: 2px solid #ff9149;
        }
      </style>
</head>
<!-- END: Head-->

<!-- BEGIN: Body-->

<body body class="vertical-layout vertical-content-menu 2-columns   fixed-navbar" data-open="click"
  data-menu="vertical-content-menu" data-col="2-columns">
  <!-- top-menu partial -->
  <!-- <%- include('../partials/top-menu.ejs') %> -->

    <!-- BEGIN: Content-->
    <div class="app-content content">
      <div class="content-wrapper">
        <!-- main-menu partial -->
        <!-- <%- include('../partials/main-menu.ejs') %> -->
          <div class="content-body card card-body border-left-success border-right-success ">
            <div class="page-header-container col-12 p-0">
              <h1 class="sec-title text-bold-500 primary" id="greeting">Welcome Back! </h1>
            </div>
          </div>



          <div class="content-body">
            <% if(currentUser.user_type=='super_admin' ) { %>
              <h2 class="text-center font-500"> General View</h2>
              <hr>
              <div class="row">
                <div class="col-xl-3 col-lg-6 col-md-6 col-12">
                  <div class="card">
                    <div class="card-content clickable" onclick="location.href = '/clients'">
                      <div class="card-body">
                        <div class="media d-flex">
                          <div class="align-self-center">
                            <i class="ficon ft-briefcase primary font-large-2 float-left" aria-hidden="true"></i>
                          </div>
                          <div class="media-body text-right">
                            <h3 id="clientsCount">-</h3>
                            <span>Clients</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-xl-3 col-lg-6 col-md-6 col-12">
                  <div class="card">
                    <div class="card-content clickable" onclick="location.href = '/clients'">
                      <div class="card-body">
                        <div class="media d-flex">
                          <div class="align-self-center">
                            <i class="ficon la la-phone dark font-large-2 float-left" aria-hidden="true"></i>
                          </div>
                          <!-- <div class="media-body text-right">
                            <h3 id="callAgentsCount">-</h3>
                            <span>Call Agents</span>
                          </div> -->
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-xl-3 col-lg-6 col-md-6 col-12">
                  <div class="card">
                    <div class="card-content clickable" onclick="location.href = '/clients'">
                      <div class="card-body">
                        <div class="media d-flex">
                          <div class="align-self-center">
                            <i class="ficon fa fa-headset dark font-large-2 float-left" aria-hidden="true"></i>
                          </div>
                          <div class="media-body text-right">
                            <h3 id="chatbotsCount">-</h3>
                            <span>Chatbots</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- TODO: fix the counts and show -->
                <div class="col-xl-3 col-lg-6 col-md-6 col-12 d-none">
                  <div class="card">
                    <div class="card-content clickable" onclick="location.href = '/clients'">
                      <div class="card-body">
                        <div class="media d-flex">
                          <div class="align-self-center">
                            <i class="ficon ft-user primary font-large-2 float-left" aria-hidden="true"></i>
                          </div>
                          <div class="media-body text-right">
                            <h3 id="chatUsersCount">-</h3>
                            <span>Users</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-xl-3 col-lg-6 col-md-6 col-12">
                  <div class="card">
                    <div class="card-content clickable" onclick="location.href = ''">
                      <div class="card-body">
                        <div class="media d-flex">
                          <div class="align-self-center">
                            <i class="ficon la la-comments dark font-large-2 float-left" aria-hidden="true"></i>
                          </div>
                          <div class="media-body text-right">
                            <h3 id="chatSessionsCount">-</h3>
                            <span>Sessions</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <% } %>

                <!-- Restaurant List Section -->
                <div class="restaurant-list-section">
                 
                  <div class="row" id="restaurantList">
                    <!-- Add Restaurant Card -->
                    <div class="col-xl-3 col-lg-4 col-md-6 col-12 mb-4">
                      <div class="add-restaurant-card"
                           data-toggle="modal" data-target="#createRestaurantModal">
                        <div class="add-icon">
                          <i class="la la-plus"></i>
                        </div>
                        <h5>Add Restaurant</h5>
                      </div>
                    </div>
                    <!-- Restaurant cards will be loaded here by JS -->
                  </div>
                </div>
          </div>

          <div id="userType"></div>
          <%- include('../partials/alert.ejs') %>
      </div>
    </div>
    <!-- END: Content-->
    <div class="sidenav-overlay"></div>
    <div class="drag-target"></div>

    <!-- Restaurant Creation Modal -->
    <div class="modal fade" id="createRestaurantModal" tabindex="-1" role="dialog"
      aria-labelledby="createRestaurantModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title text-white" id="createRestaurantModalLabel"><i class="fas fa-plus-circle mr-1"></i>
              Create New Restaurant</h5>
            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body p-0">
            <div class="form-content p-3">
              <form id="createRestaurantForm">
                <!-- Basic Information Section -->
                <div class="card mb-3">
                  <div class="card-header bg-light">
                    <h4 class="card-title mb-0"><i class="fas fa-info-circle"></i> Basic Information</h4>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="name"><i class="fas fa-store"></i> Restaurant Name</label>
                          <input type="text" id="name" name="name" class="form-control" placeholder="Alex Restaurant"
                            required>
                        </div>
                      </div>
                      <!-- <div class="col-md-6">
                        <div class="form-group">
                          <label for="businessType"><i class="fas fa-tag"></i> Business Type</label>
                          <input type="text" id="businessType" name="businessType" class="form-control" placeholder="restaurant" value="restaurant" required>
                        </div>
                      </div> -->
                      <div class="col-12">
                        <div class="form-group">
                          <label for="description"><i class="fas fa-align-left"></i> Description</label>
                          <textarea id="description" name="description" class="form-control"
                            placeholder="A fine dining restaurant serving international cuisine" rows="3"
                            required></textarea>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Contact Information Section -->
                <div class="card mb-3">
                  <div class="card-header bg-light">
                    <h4 class="card-title mb-0"><i class="fas fa-address-card"></i> Contact Information</h4>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="phone"><i class="fas fa-phone"></i> Phone Number</label>
                          <input type="text" id="phone" name="phone" class="form-control" placeholder="+1-555-123-4567"
                            required>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="email"><i class="fas fa-envelope"></i> Email Address</label>
                          <input type="email" id="email" name="email" class="form-control"
                            placeholder="contact@samplerestaurant.com" required>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Address Information Section -->
                <div class="card mb-3">
                  <div class="card-header bg-light">
                    <h4 class="card-title mb-0"><i class="fas fa-map-marker-alt"></i> Restaurant Address</h4>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-12">
                        <div class="form-group">
                          <label for="street">Street Address</label>
                          <input type="text" id="street" name="address[street]" class="form-control"
                            placeholder="123 Main Street" required>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="city">City</label>
                          <input type="text" id="city" name="address[city]" class="form-control" placeholder="New York"
                            required>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="state">State</label>
                          <input type="text" id="state" name="address[state]" class="form-control" placeholder="NY"
                            required>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="zipCode">Zip Code</label>
                          <input type="text" id="zipCode" name="address[zipCode]" class="form-control"
                            placeholder="10001" required>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Operating Hours Section -->
                <div class="card mb-3">
                  <div class="card-header bg-light">
                    <h4 class="card-title mb-0"><i class="fas fa-clock"></i> Operating Hours</h4>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="openTime">Opening Time (24-hour format)</label>
                          <input type="time" id="openTime" name="operatingHours[openTime]" class="form-control"
                            value="09:00" required>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="closeTime">Closing Time (24-hour format)</label>
                          <input type="time" id="closeTime" name="operatingHours[closeTime]" class="form-control"
                            value="22:00" required>
                        </div>
                      </div>
                      <div class="col-12 mt-2">
                        <!-- <div class="custom-control custom-checkbox">
                          <input type="checkbox" class="custom-control-input" id="isOpen" name="operatingHours[isOpen]"
                            value="true" checked>
                          <label class="custom-control-label" for="isOpen">Currently Open for Business</label>
                        </div> -->
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Status Section -->
                <!-- <div class="card">
                  <div class="card-header bg-light">
                    <h4 class="card-title mb-0"><i class="fas fa-toggle-on"></i> Status</h4>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="form-group mb-0">
                          <label for="status">Restaurant Status</label>
                          <select id="status" name="status" class="form-control" required>
                            <option value="">Select status...</option>
                            <option value="active" selected>Active</option>
                            <option value="inactive">Inactive</option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>
                </div> -->
              </form>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-light-secondary" data-dismiss="modal">
              <i class="fas fa-times"></i> Cancel
            </button>
            <button type="button" class="btn btn-primary" id="saveRestaurantBtn">
              <i class="fas fa-save"></i> Create Restaurant
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 9999">
      <div id="restaurantToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
          <i class="fas fa-check-circle me-2"></i>
          <strong class="me-auto">Success</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
          Restaurant created successfully!
        </div>
      </div>
    </div>

    <!-- footer partial -->
    <%- include('../partials/footer.ejs') %>

      <!-- scripts partial -->
      <%- include('../partials/scripts-without-pace.ejs') %>

        <!-- Variables used in index.js -->
        <script>
          const currentUser = '<%= currentUser.user_type %>';
        </script>
        <script src="/public/js/pages/index.js"></script>

        <!-- Restaurant List Script -->
        <script>
          document.addEventListener('DOMContentLoaded', function () {
            loadRestaurants();

            // Setup create restaurant modal
            const createRestaurantForm = document.getElementById('createRestaurantForm');
            const saveRestaurantBtn = document.getElementById('saveRestaurantBtn');

            saveRestaurantBtn.addEventListener('click', function () {
              // Trigger form validation
              if (!createRestaurantForm.checkValidity()) {
                createRestaurantForm.reportValidity();
                return;
              }

              // Set button to loading state
              saveRestaurantBtn.disabled = true;
              saveRestaurantBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';

              // Get form data
              const formData = new FormData(createRestaurantForm);
              const userId = '<%= currentUser._id %>';

              // Convert form data to JSON
              const restaurantData = {
                name: formData.get('name'),
                description: formData.get('description'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                address: {
                  street: formData.get('address[street]'),
                  city: formData.get('address[city]'),
                  state: formData.get('address[state]'),
                  zipCode: formData.get('address[zipCode]')
                },
                businessType: "restaurant",
                operatingHours: {
                  openTime: formData.get('operatingHours[openTime]'),
                  closeTime: formData.get('operatingHours[closeTime]'),
                  isOpen: formData.get('operatingHours[isOpen]') === 'true'
                },
                status: "active",
                owner: userId
              };

              // Get auth token from cookies
              const token = document.cookie.split('; ')
                .find(row => row.startsWith('authToken='))
                ?.split('=')[1] || '';

              if (!token) {
                showToast('Authentication required', true);
                resetSaveButton();
                return;
              }

              // Submit via AJAX
              fetch('/restaurants', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(restaurantData)
              })
                .then(response => {
                  if (!response.ok) {
                    return response.json().then(err => {
                      throw new Error(err.message || `Server error: ${response.status}`);
                    });
                  }
                  return response.json();
                })
                .then(data => {
                  // Success
                  showToast('Restaurant created successfully!');
                  createRestaurantForm.reset();
                  $('#createRestaurantModal').modal('hide');

                  location.reload();
                  // Reload restaurant list
                  loadRestaurants();
                })
                .catch(error => {
                  // Error handling
                  console.error('Error:', error);
                  showToast(`Error: ${error.message}`, true);
                })
                .finally(() => {
                  resetSaveButton();
                });
            });

            function resetSaveButton() {
              saveRestaurantBtn.disabled = false;
              saveRestaurantBtn.innerHTML = '<i class="fas fa-save"></i> Create Restaurant';
            }

            function showToast(message, isError = false) {
              const toast = document.getElementById('restaurantToast');
              const toastMessage = document.getElementById('toastMessage');
              const toastHeader = toast.querySelector('.toast-header');

              toastMessage.textContent = message;

              if (isError) {
                toastHeader.classList.remove('bg-success');
                toastHeader.classList.add('bg-danger');
                toastHeader.querySelector('i').className = 'fas fa-exclamation-circle me-2';
                toastHeader.querySelector('strong').textContent = 'Error';
              } else {
                toastHeader.classList.remove('bg-danger');
                toastHeader.classList.add('bg-success');
                toastHeader.querySelector('i').className = 'fas fa-check-circle me-2';
                toastHeader.querySelector('strong').textContent = 'Success';
              }

              // Show the toast
              $('.toast').toast('show');
            }
          });

          async function loadRestaurants() {

            // console.log(currentUser,"currentUsercurrentUser");
            try {
              // Get auth token from cookies
              const token = document.cookie.split('; ')
                .find(row => row.startsWith('authToken='))
                ?.split('=')[1] || '';

              if (!token) {
                showError('Authentication required');
                return;
              }

              // Get current user ID
              const userId = '<%= currentUser._id %>';


              console.log(userId,"userIduserId");
              // Fetch restaurants from API
              const response = await fetch(`/restaurants/owner/${userId}`, {
                headers: {
                  'Authorization': `Bearer ${token}`
                }
              });

              if (!response.ok) {
                throw new Error('Failed to load restaurants');
              }

              const data = await response.json();
              const restaurants = data.restaurants || [];

              // Hide loading indicator
              document.getElementById('loadingRestaurants')?.remove();

              // Display restaurants
              const restaurantList = document.getElementById('restaurantList');

              // Keep the Add Restaurant card as the first card
              let restaurantHTML = restaurantList.innerHTML; // This already has the Add Restaurant card

              if (restaurants.length === 0) {
                restaurantHTML += `
                  <div class="col-12 text-center">
                    <div class="empty-state">
                      <div class="empty-state-icon">
                        <i class="la la-utensils"></i>
                      </div>
                      <h4 class="mt-2">No restaurants found</h4>
                      <p class="text-muted mb-3">You haven't added any restaurants yet.</p>
                      <button type="button" class="btn btn-primary btn-lg rounded-pill shadow-sm mt-1" data-toggle="modal" data-target="#createRestaurantModal">
                        <i class="ft-plus mr-1"></i> Add Your First Restaurant
                      </button>
                    </div>
                  </div>
                `;
                restaurantList.innerHTML = restaurantHTML;
                return;
              }

              // Create restaurant cards
              restaurants.forEach(restaurant => {
                const created = restaurant.createdAt ? new Date(restaurant.createdAt).toLocaleDateString() : 'N/A';
                const phone = restaurant.phone || '123123';

                restaurantHTML += `
                  <div class="col-xl-3 col-lg-4 col-md-6 col-12 mb-4">
                    <a href="/restaurants/my-restaurants/detail/${restaurant._id}" class="restaurant-card-link">
                      <div class="restaurant-card">
                        <div class="restaurant-card-content">
                          <div class="phone-icon">
                            <i class="la la-phone"></i>
                          </div>
                          <h5>${restaurant.name}</h5>
                          <p>${phone}</p>
                          <p>Created: ${created}</p>
                        </div>
                        <div class="view-details-btn">
                          <i class="la la-eye mr-1"></i> View Details
                        </div>
                      </div>
                    </a>
                  </div>
                `;
              });

              restaurantList.innerHTML = restaurantHTML;
            } catch (error) {
              console.error('Error loading restaurants:', error);
              document.getElementById('loadingRestaurants').innerHTML = `
                <div class="alert alert-danger" role="alert">
                  <i class="ft-alert-circle mr-1"></i>
                  Error loading restaurants: ${error.message}
                </div>
              `;
            }
          }

          function showError(message) {
            const restaurantList = document.getElementById('restaurantList');
            restaurantList.innerHTML = `
              <div class="col-12">
                <div class="alert alert-danger" role="alert">
                  <i class="ft-alert-circle mr-1"></i>
                  ${message}
                </div>
              </div>
            `;
            document.getElementById('loadingRestaurants').style.display = 'none';
          }
        </script>

        <style>
          .restaurant-list-section {
            padding: 0;
          }
          
          .create-btn {
            border-radius: 4px;
            padding: 0.5rem 1rem;
            font-weight: 500;
          }
          
          .add-restaurant-card {
            height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed #0051a1;
            border-radius: 8px;
            background-color: white;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 1rem;
          }
          
          .add-restaurant-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 20px rgba(0, 81, 161, 0.15);
          }
          
          .add-restaurant-card .add-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #0051a1;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
          }
          
          .add-restaurant-card:hover .add-icon {
            transform: rotate(90deg);
          }
          
          .add-restaurant-card .add-icon i {
            color: white;
            font-size: 20px;
          }
          
          .add-restaurant-card h5 {
            color: #333;
            font-weight: 500;
            margin: 0;
          }
          
          .restaurant-card {
            height: 180px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: none;
            background-color: white;
            padding: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
          }
          
          .restaurant-card-link {
            text-decoration: none;
            color: inherit;
            height: 100%;
            display: block;
          }
          
          .restaurant-card-link:hover .restaurant-card {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.1);
            background-color: #f8f8ff;
          }
          
          .phone-icon {
            width: 24px;
            height: 24px;
            background-color: #f8f8f8;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            transition: background-color 0.3s ease;
          }
          
          .restaurant-card-link:hover .phone-icon {
            background-color: #eeeeff;
          }
          
          .phone-icon i {
            color: #666;
            font-size: 14px;
          }
          
          .restaurant-card h5 {
            color: #333;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 0.5rem;
            transition: color 0.3s ease;
          }
          
          .restaurant-card-link:hover h5 {
            color: #0051a1;
          }
          
          .restaurant-card p {
            color: #666;
            margin-bottom: 0.25rem;
            font-size: 14px;
          }
          
          .restaurant-card-content {
            flex: 1;
            margin-bottom: 40px;
          }
          
          .view-details-btn {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: #0051a1;
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 14px;
            font-weight: 500;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            transition: background-color 0.3s ease;
          }
          
          .restaurant-card-link:hover .view-details-btn {
            background-color: #003d7a;
          }
          
          .restaurant-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent 0%, rgba(0, 81, 161, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
          }
          
          .restaurant-card-link:hover .restaurant-card::after {
            opacity: 1;
          }
        </style>
</body>
<!-- END: Body-->

</html>